<WelcomeScreen>:
    BoxLayout:
        orientation: 'vertical'
        Label:
            font_size: root.height/30
            text: ('[b]Welcome to the Rating App! [/b] \nPlease read the instructions carefully before proceeding.')
            markup: True
            size_hint_y: 0.15
        Label:
            text: 'Instructions follow here...'
            size_hint_y: 0.7
        BoxLayout:
            size_hint_y: 0.15
            Button:
                font_size: root.height/40
                text: 'Back'
                # This button does nothing for now, just a placeholder
                on_release: app.root.current = 'welcome'
                opacity: .5 # Make invisible as it's just a placeholder
            FocusableButton:
                id: btn_next
                font_size: root.height/40
                text: 'Next'
                on_release: app.root.current = 'login'


<LoginScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: 20
        spacing: 20

        Label:
            size_hint_y: 0.15
            text: ''

        Label:
            text: 'Have you already participated in this study and therefore used the app before?'
            font_size: root.height/35
            size_hint_y: 0.15
            halign: 'center'
            valign: 'middle'
            text_size: self.size

        BoxLayout:
            size_hint_y: 0.1
            spacing: 20
            padding: [100, 0, 100, 0]

            FocusableToggleButton:
                id: btn_participated_yes
                font_size: root.height/40
                text: 'Yes'
                group: "participation"
                on_state: root.participation_clicked(self, self.state, True)

            FocusableToggleButton:
                id: btn_participated_no
                font_size: root.height/40
                text: 'No'
                group: "participation"
                on_state: root.participation_clicked(self, self.state, False)

        # Message for new users (No selected)
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: 0.25
            opacity: 1 if root.has_participated == False else 0
            disabled: root.has_participated != False
            padding: [50, 20, 50, 20]

            Label:
                text: 'You will now be forwarded to the questionnaire, where you are asked some questions and your user id is being generated. Proceed?'
                font_size: root.height/45
                halign: 'center'
                valign: 'middle'
                text_size: self.size

        # User ID input for returning users (Yes selected)
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: 0.25
            opacity: 1 if root.has_participated == True else 0
            disabled: root.has_participated != True
            padding: [50, 20, 50, 20]
            spacing: 10

            Label:
                text: 'Please enter your user ID:'
                font_size: root.height/40
                size_hint_y: 0.3

            FocusableTextInput:
                id: input_user_id
                font_size: root.height/35
                hint_text: 'Enter your user ID'
                size_hint_y: 0.4
                multiline: False
                on_text: root.user_id_input_changed(self, self.text)

            Label:
                text: ('User ID found' if root.user_id_exists else ('User ID not found' if root.user_id_input else ''))
                font_size: root.height/45
                size_hint_y: 0.3
                color: (0, 0.8, 0, 1) if root.user_id_exists else (1, 0, 0, 1)

        Label:
            size_hint_y: 0.2
            text: ''

        BoxLayout:
            size_hint_y: 0.15
            spacing: 10
            FocusableButton:
                id: btn_back
                font_size: root.height/40
                text: 'Back'
                on_release: app.root.current = 'welcome'
            FocusableButton:
                id: btn_next
                font_size: root.height/40
                text: 'Next'
                on_release: root.proceed_next()


<QuestionnaireScreen>:
    BoxLayout:
        orientation: 'vertical'

        # Input Form Panel (shown when user_id not yet confirmed)
        BoxLayout:
            orientation: 'vertical'
            opacity: 1 if not root.user_id_confirmed else 0
            disabled: root.user_id_confirmed
            size_hint_y: 1 if not root.user_id_confirmed else None
            height: 0 if root.user_id_confirmed else self.parent.height

            # Header
            Label:
                text: 'Please enter your information below.'
                font_size: root.height/35
                size_hint_y: None
                height: '48dp'

            # Dynamically generated form (configured via config.yaml)
            # Takes up all remaining space
            ScrollView:
                do_scroll_x: False
                do_scroll_y: True
                size_hint_y: 1
                bar_width: 10
                scroll_type: ['bars', 'content']

                BoxLayout:
                    id: form_container
                    orientation: 'vertical'
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: 2

            # Navigation buttons - fixed at bottom
            BoxLayout:
                size_hint_y: None
                height: '60dp'
                spacing: 10
                padding: [10, 5, 10, 5]
                FocusableButton:
                    id: btn_back
                    font_size: root.height/40
                    text: 'Back'
                    on_release: app.root.current = 'login'
                FocusableButton:
                    id: btn_next
                    font_size: root.height/40
                    text: 'Next'
                    on_release: root.show_user_id_confirmation()

        # User ID Display Panel (shown after user_id is confirmed)
        BoxLayout:
            orientation: 'vertical'
            opacity: 1 if root.user_id_confirmed else 0
            disabled: not root.user_id_confirmed
            size_hint_y: 1 if root.user_id_confirmed else None
            height: 0 if not root.user_id_confirmed else self.parent.height
            padding: 50
            spacing: 30

            Label:
                size_hint_y: 0.3
                text: ''

            Label:
                text: 'This is your user id. Please memorize it. You will have to enter it when again opening the app.'
                font_size: root.height/50
                size_hint_y: 0.2
                halign: 'center'
                valign: 'middle'
                text_size: self.size

            Label:
                text: root.display_user_id
                font_size: root.height/20
                size_hint_y: 0.3
                bold: True
                halign: 'center'
                valign: 'middle'

            BoxLayout:
                size_hint_y: 0.2
                spacing: 10
                padding: [50, 0, 50, 0]

                FocusableButton:
                    id: btn_back_to_form
                    text: 'Back to User Data'
                    font_size: root.height/40
                    on_release: root.back_to_form()

                FocusableButton:
                    id: btn_proceed_video
                    text: 'Understood. Proceed'
                    font_size: root.height/40
                    on_release: root.proceed_to_video()

<ColoredLabel@Label>:
    canvas.before:
        Color:
            rgba: (100/255, 100/255, 100/255,1)
        Rectangle:
            pos: self.pos
            size: self.size
        Color:
            rgba: (0,0,0,1)
        Line:
            rectangle: self.x, self.y, self.width, self.height
            width: .8

<VideoPlayerScreen>:
    BoxLayout:
        orientation: 'vertical'
        BoxLayout:
            size_hint_y: root.metadata_display_height
            ColoredLabel:
                id: team_label
                font_size: root.height/40
                text: 'No Team'
                bold: True
            ColoredLabel:
                id: player_label
                font_size: root.height/40
                text: 'No Player'
                bold: True
            ColoredLabel:
                id: type_label
                font_size: root.height/40
                text: 'No Type'
                bold: True
            ColoredLabel:
                id: bodypart_label
                font_size: root.height/40
                text: 'No Bodypart'
                bold: True
            ColoredLabel:
                id: jerseynumber_label
                font_size: root.height/40
                text: 'No Jersey Number'
                bold: True
        BoxLayout:
            size_hint_y: root.video_player_height
            orientation: 'horizontal'

            VideoPlayer:
                id: video_player
                size_hint_x: .65
                source: ''
                state: 'stop'
                options: {'eos': 'loop'}
                allow_stretch: True
            BoxLayout:
                size_hint_x: .35
                orientation: 'vertical'
                canvas.before:
                    Color:
                        rgba: (0, 0, 0, 1)  # Black background
                    Rectangle:
                        pos: self.pos
                        size: self.size
                BoxLayout:
                    id: plot_container
                    size_hint_y: None
                    height: self.parent.width * 0.67  # Maintain aspect ratio
                    orientation: 'vertical'
                Widget:
                    # Spacer to push plot to top

        BoxLayout:
            size_hint_y: root.control_buttons_height
            orientation: 'vertical'

            Label:
                id: info_label
                size_hint_y: 0.3
                font_size: root.height/50

            BoxLayout:
                size_hint_y: 0.7
                Button:
                    size_hint_x: .25
                    font_size: root.height/40
                    text: 'Back to User Data'
                    on_release: root.confirm_back_to_questionnaire()
                ToggleButton:
                    id: btn_notrec
                    font_size: root.height/40
                    size_hint_x: .3
                    text: 'Action not Recognized'
                    on_state: root.action_not_recognized = (self.state == 'down'); root.set_scale_value('', '')
                Button:
                    id: submit_button
                    font_size: root.height/40
                    size_hint_x: .4
                    text: 'Submit Rating'
                    disabled: (not root.has_any_rating) and (not root.action_not_recognized)
                    opacity: 1 if not self.disabled else .5
                    on_release:
                        root.submit_rating()

        ########### Dynamic Rating Scales (configured via config.yaml) ###########
        # This container will be populated dynamically at runtime based on
        # the rating_scales configuration in config.yaml
        BoxLayout:
            id: scales_container
            orientation: 'vertical'
            size_hint_y: root.rating_scales_height

